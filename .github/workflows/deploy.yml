# ğŸ“¦ Next.js í”„ë¡œì íŠ¸ë¥¼ AWS Lambda + S3 + CloudFrontì— ë°°í¬í•˜ê¸° ìœ„í•œ GitHub Actions Workflow

name: Deploy Next.js to Lambda + S3 + CloudFront (with Layer)

on:
  push:
    branches: [main] # main ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰ë¨

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: âœ… ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      # 2. Node.js ì„¤ì •
      - name: ğŸŸ¦ Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      # 4. jq ì„¤ì¹˜ (JSON íŒŒì‹±ìš©)
      - name: ğŸ”§ jq ì„¤ì¹˜
        run: sudo apt-get update && sudo apt-get install -y jq

      # 5. Lambda Layerë¥¼ ìœ„í•œ ìµœì†Œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (react/react-domë§Œ í¬í•¨)
      - name: ğŸ“¦ Lambda Layer ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          mkdir -p layer/nodejs
          cd layer/nodejs
          echo '{
            "name": "lambda-layer",
            "version": "1.0.0",
            "private": true,
            "dependencies": {
              "react": "^19.0.0",
              "react-dom": "^19.0.0"
            }
          }' > package.json
          npm install --omit=dev

      # 6. Layer ìµœì í™” ë° ì••ì¶•
      - name: ğŸ§¹ Lambda Layer ìµœì í™” ë° ì••ì¶•
        run: |
          cd layer
          find nodejs -type f -name "*.md" -delete || true
          find nodejs -type f -name "*.map" -delete || true
          find nodejs -type d -name "test" -exec rm -rf {} + || true
          find nodejs -type d -name "__tests__" -exec rm -rf {} + || true
          zip -r layer.zip nodejs

      # 7. AWS ìê²© ì¦ëª… ì„¤ì •
      - name: ğŸ” AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 8. Lambda Layer ì—…ë¡œë“œ ë° ê²Œì‹œ
      - name: â˜ï¸ Lambda Layer ì—…ë¡œë“œ ë° ê²Œì‹œ
        run: |
          aws s3 cp layer/layer.zip s3://${{ secrets.S3_LAMBDA_ADDRESS }}/layer/layer.zip
          PUBLISH_RESULT=$(aws lambda publish-layer-version \
            --layer-name next-layer \
            --content S3Bucket=${{ secrets.S3_LAMBDA_ADDRESS }},S3Key=layer/layer.zip \
            --compatible-runtimes nodejs20.x \
            --description "Next.js runtime dependencies" \
            --region ap-northeast-2)
          LAYER_ARN=$(echo $PUBLISH_RESULT | jq -r '.LayerVersionArn')
          echo "LAMBDA_LAYER_ARN=$LAYER_ARN" >> $GITHUB_ENV

      # 9. Next.js ë¹Œë“œ ë° Lambda íŒŒì¼ êµ¬ì„±
      - name: ğŸ”¨ Lambda ì‹¤í–‰ íŒŒì¼ ë° ë¦¬ì†ŒìŠ¤ ì¤€ë¹„
        run: |
          npm run build
          mkdir -p lambda

          # standalone ë””ë ‰í† ë¦¬ ë³µì‚¬
          cp -r .next/standalone/* lambda/
          cp index.js lambda/index.js

          # .next/required-server-files.json ë³µì‚¬
          mkdir -p lambda/.next
          cp .next/required-server-files.json lambda/.next/required-server-files.json

          # required-server-files.json ë‚´ë¶€ íŒŒì¼ ë³µì‚¬
          REQUIRED_FILES=$(node -e "console.log(require('./.next/required-server-files.json').files.join('\n'))")
          for file in $REQUIRED_FILES; do
            if [ -f "$file" ]; then
              mkdir -p "lambda/$(dirname "$file")"
              cp "$file" "lambda/$file"
            fi
          done

          # .next/server ì „ì²´ ë³µì‚¬ (ì¤‘ë³µ ë°©ì§€)
          cp -r .next/server lambda/.next/

          # ì •ì  íŒŒì¼ ë³µì‚¬
          if [ -d ".next/static" ]; then
            mkdir -p lambda/.next
            cp -r .next/static lambda/.next/static
          fi

          # next ëª¨ë“ˆ ë³µì‚¬
          mkdir -p lambda/node_modules
          cp -r node_modules/next lambda/node_modules/

          # Layerë¡œ ì´ë™í•œ ëª¨ë“ˆ ì œê±°
          rm -rf lambda/node_modules/react || true
          rm -rf lambda/node_modules/react-dom || true

          # ğŸ”§ [ì¶”ê°€] SSR í•¸ë“¤ëŸ¬ ëˆ„ë½ ë°©ì§€: ì§ì ‘ ë³µì‚¬
          SSR_HANDLER_DIR=".next/server/app/ssr"
          if [ -f "$SSR_HANDLER_DIR/page.js" ]; then
            mkdir -p "lambda/$SSR_HANDLER_DIR"
            cp "$SSR_HANDLER_DIR/page.js" "lambda/$SSR_HANDLER_DIR/"
          fi
          if [ -f "$SSR_HANDLER_DIR/page.js.nft.json" ]; then
            cp "$SSR_HANDLER_DIR/page.js.nft.json" "lambda/$SSR_HANDLER_DIR/"
          fi

      # 10. Lambda ì½”ë“œ ì••ì¶•
      - name: ğŸ“¦ Lambda ì½”ë“œ ì••ì¶•
        run: |
          cd lambda
          zip -r ../lambda.zip .

      # 11. Lambda í•¨ìˆ˜ ì½”ë“œ ì—…ë°ì´íŠ¸
      - name: ğŸš€ Lambda í•¨ìˆ˜ ì½”ë“œ ì—…ë°ì´íŠ¸
        run: |
          aws s3 cp lambda.zip s3://${{ secrets.S3_LAMBDA_ADDRESS }}/lambda/lambda.zip
          aws lambda update-function-code \
            --function-name nextJs \
            --s3-bucket ${{ secrets.S3_LAMBDA_ADDRESS }} \
            --s3-key lambda/lambda.zip

      # 12. Lambda ìƒíƒœ ëŒ€ê¸° í›„ Layer ì—°ê²°
      - name: Wait for Lambda update to complete and attach Layer
        run: |
          echo "â³ Lambda í•¨ìˆ˜ ìƒíƒœ í™•ì¸ ì¤‘..."
          for i in {1..60}; do
            STATUS=$(aws lambda get-function-configuration --function-name nextJs --query 'LastUpdateStatus' --output text)
            echo "í˜„ì¬ ìƒíƒœ: $STATUS"
            if [ "$STATUS" = "Successful" ]; then
              echo "âœ… Lambda í•¨ìˆ˜ ì—…ë°ì´íŠ¸ ì™„ë£Œë¨"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "âŒ Lambda ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"
              exit 1
            fi
            sleep 5
          done

          echo "ğŸ”— Layer ì—°ê²° ì¤‘..."
          aws lambda update-function-configuration \
            --function-name nextJs \
            --layers $LAMBDA_LAYER_ARN

      # 13. ì •ì  ìì‚° S3ë¡œ ì—…ë¡œë“œ
      - name: ğŸ–¼ ì •ì  ìì‚° S3 ì—…ë¡œë“œ
        run: |
          aws s3 sync public ${{ secrets.S3_STORAGE_ADDRESS }}/public --delete
          if [ -d ".next/static" ]; then
            aws s3 sync .next/static ${{ secrets.S3_STORAGE_ADDRESS }}/_next/static --delete
          fi

      # 14. CloudFront ìºì‹œ ë¬´íš¨í™”
      - name: ğŸš« CloudFront ìºì‹œ ë¬´íš¨í™”
        run: |
          if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
              --paths "/*"
          fi
